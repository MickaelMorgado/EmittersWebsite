<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../assets/css.css" />
    <link rel="stylesheet" href="../assets/reusables.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    />
    <link
      rel="icon"
      href="https://ui-avatars.com/api/?name=H&rounded=true&background=000000&color=ffffff"
      type="image/png"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../assets/reusables.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        document.title = `HYTEK - ${
          document.getElementsByTagName('h1')[0].innerText
        }`;
      });
    </script>
    <link rel="stylesheet" href="index6.css" />
  </head>

  <body class="h-style">
    <div id="upload-section">
      <div class="h-padded">
        <div class="h-flex h-flex--column">
          <div>
            <h1>BackTesting</h1>
            <p>
              Export MT5 bars by using CTRL+U then go to Bars tab, filter the
              range and export, then upload it here:
            </p>
            <p>
              More info:
              <a
                target="_blank"
                href="https://myforex.com/en/mt5guide/export-historicaldata.html"
                >Export Historical Data</a
              >
              <a target="_blank" href="https://www.mql5.com/en/forum/356227"
                >Limited History Issue</a
              >
            </p>
          </div>
          <hr class="h-hr" />
          <label for="csvFileInput">Upload CSV bars</label>
          <div class="h-flex">
            <input
              type="file"
              id="csvFileInput"
              accept=".csv"
              class="h-input-effects"
              style="width: 80%"
            />
            <button
              id="csvRefresh"
              title="Refresh"
              class="mybutton h-input-effects notify-bullet"
            >
              <i class="fas fa-repeat"></i>
            </button>
          </div>
          <hr class="h-hr" />
          <div class="h-flex">
            <div class="h-form-group">
              <label for="prevDate">Prev</label>
              <button
                id="prevDate"
                title="Previous Date"
                class="mybutton h-input-effects"
                onclick="changeDate(-1)"
              >
                <i class="fas fa-arrow-left"></i>
              </button>
            </div>
            <div class="h-form-group">
              <label for="NavigateTroughtDates">Navigate trought session</label>
              <div id="ntd-notify" class="notify-bullet">
                <select
                  id="NavigateTroughtDates"
                  class="h-input-effects"
                  style="width: 100%"
                ></select>
              </div>
            </div>
            <div class="h-form-group">
              <label for="nextDate">Next</label>
              <button
                id="nextDate"
                title="Next Date"
                class="mybutton h-input-effects"
                onclick="changeDate(1)"
              >
                <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
          <script>
            function changeDate(direction) {
              const select = document.getElementById('NavigateTroughtDates');
              let newIndex = select.selectedIndex + direction;
              if (newIndex >= 0 && newIndex < select.options.length) {
                select.selectedIndex = newIndex;
                select.dispatchEvent(new Event('change'));
              }
            }
          </script>
          <!--hr class="h-hr" />
        <label for="">Hidder</label>
        <div class="h-flex">
          <button id="hidderReset" title="Restart" class="mybutton h-input-effects" onclick="hidderRestart()">
            <i class="fas fa-repeat"></i>
          </button>
          <button id="hidderNextCandle" title="Reveal Next Candle" class="mybutton h-input-effects"
            onclick="hidderNext()">
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
        <script>
          document.addEventListener('DOMContentLoaded', () => {
            const hidder = document.getElementById('hidder');
            const moveButton = document.getElementById('hidderNextCandle');
            let intervalId;

            function moveElement() {
              if (!hidder.style.left) {
                hidder.style.left = '800px';
              }
              hidder.style.left = parseInt(hidder.style.left, 10) + 10 + 'px';
            }

            moveButton.addEventListener('mousedown', () => {
              intervalId = setInterval(moveElement, 50);
            });

            moveButton.addEventListener('mouseup', () => {
              clearInterval(intervalId);
            });

            moveButton.addEventListener('mouseleave', () => {
              clearInterval(intervalId);
            });
          });

          function hidderRestart() {
            let hidder = document.getElementById('hidder');
            if (hidder.style.display === 'none') {
              hidder.style.display = 'block';
            } else {
              hidder.style.display = 'none';
            }
            hidder.style.left = "800px";
          }
        </script-->
          <hr class="h-hr" />
          <label for="colorSettingsTutorial">Application theme</label>
          <div>
            <select
              id="themeSelector"
              class="h-input-effects"
              onchange="applyTheme()"
            >
              <option value="">-</option>
              <option value="bullishColor=00FF00&bearishColor=FF0000">
                Green / Red
              </option>
              <option value="bullishColor=0000FF&bearishColor=FF00FF">
                Blue / Magenta
              </option>
              <option value="bullishColor=FFFF00&bearishColor=00FFFF">
                Yellow / Cyan
              </option>
              <option value="bullishColor=00cdff&bearishColor=555555">
                Light Blue / Grey
              </option>
              <option value="bullishColor=FF5500&bearishColor=444444">
                Volcanic
              </option>
              <option value="bullishColor=FFFFFF&bearishColor=FF0000">
                Devil
              </option>
              <option value="bullishColor=03A062&bearishColor=222222">
                Matrix
              </option>
            </select>
            <script>
              function applyTheme() {
                const urlParams = new URLSearchParams(window.location.search);

                const themeSelector = document.getElementById('themeSelector');
                const selectedTheme = themeSelector.value;
                //const currentUrl = window.location.href.split('?')[0];
                //window.location.href = currentUrl + selectedTheme;

                urlParams.set('theme', selectedTheme);
                window.location.search = urlParams;
              }
            </script>
          </div>
          <hr class="h-hr" />
          <label for="backTestingPauseButton">Stop BackTesting</label>
          <input
            type="checkbox"
            name="backTestingPauseButton"
            id="backTestingPauseButton"
          />
          <hr class="h-hr" />
          <label title="Current progression of the current backtesting file reading. (Starting Time - Current Time - Ending Time)">File Reading Progression</label>
          <div class="flex">
            <span id="firstDate"></span>
            <span> - </span>
            <span id="currentReadingDate" class="notify-bullet"></span>
            <span> - </span>
            <span id="lastDate"></span>
          </div>
          <div id="fileReadingProgression">
            <div class="progression"></div>
          </div>
          <hr class="h-hr" />
          <label for="backtesting-hour">CSV Data</label>
          <div>
            <textarea id="csvContent" rows="10" style="width: 100%"></textarea>
          </div>
        </div>
      </div>
    </div>
    <div class="chart-section">
      <div id="loading-element" class="loading-element">
        <span class="spinner"></span>
        Backtesting is running ...
      </div>
      <div id="scichart-root"></div>
      <div id="result-panel" class="result-panel">
        <div class="result-panel-toolbar">
          <button
            id="result-panel-toolbar-content-toggler-algo"
            class="mybutton h-input-effects result-panel-toolbar-toggler"
          >
            Backtesting results (Algo)
          </button>
          <button
            id="result-panel-toolbar-content-toggler-algo-editor"
            class="mybutton h-input-effects result-panel-toolbar-toggler"
          >
            MQL Expert Advisor Generator
          </button>
          <button
            disabled
            id="result-panel-toolbar-content-toggler-review"
            class="mybutton h-input-effects result-panel-toolbar-toggler"
          >
            Review From Historical Trades
          </button>
          <button
            disabled
            id="result-panel-toolbar-content-toggler-manual"
            class="mybutton h-input-effects result-panel-toolbar-toggler"
          >
            Backtesting results (Manual)
          </button>
          <div class="spacer"></div>
          <button
            id="result-panel-toolbar-toggler"
            class="mybutton h-input-effects result-panel-toolbar-toggler"
          >
            <span><i class="fas fa-arrow-up"></i></span>
            <span><i class="fas fa-arrow-down"></i></span>
          </button>
        </div>
        <div class="result-panel-content h-hide h-flex h-flex--column">
          <h3>MQL5 Generator</h3>
          <div class="h-flex">
            <textarea
              name="signal-condition-1-code"
              id="algoEditorTextareaMain1"
              width="100%"
              rows="20"
              style="width: 100%; white-space: nowrap"
            >
//+------------------------------------------------------------------+
//|                        Simple MA Crossover Strategy              |
//+------------------------------------------------------------------+
#property strict

input int FastMAPeriod = 10;
input int SlowMAPeriod = 30;
input double LotSize = 0.1;

// Handles for indicators
int fastMA, slowMA;

//+------------------------------------------------------------------+
//| Expert initialization function                                   |
//+------------------------------------------------------------------+
int OnInit()
{
   fastMA = iMA(_Symbol, _Period, FastMAPeriod, 0, MODE_SMA, PRICE_CLOSE);
   slowMA = iMA(_Symbol, _Period, SlowMAPeriod, 0, MODE_SMA, PRICE_CLOSE);
   return(INIT_SUCCEEDED);
}

//+------------------------------------------------------------------+
//| Expert tick function                                             |
//+------------------------------------------------------------------+
void OnTick()
{
   double fastPrev = iMA(_Symbol, _Period, FastMAPeriod, 0, MODE_SMA, PRICE_CLOSE, 1);
   double fastCurr = iMA(_Symbol, _Period, FastMAPeriod, 0, MODE_SMA, PRICE_CLOSE, 0);
   double slowPrev = iMA(_Symbol, _Period, SlowMAPeriod, 0, MODE_SMA, PRICE_CLOSE, 1);
   double slowCurr = iMA(_Symbol, _Period, SlowMAPeriod, 0, MODE_SMA, PRICE_CLOSE, 0);

   // Check for crossover
   bool buySignal = (fastPrev < slowPrev && fastCurr > slowCurr);
   bool sellSignal = (fastPrev > slowPrev && fastCurr < slowCurr);

   // Close opposite positions first
   CloseAllPositions();

   if(buySignal)
      trade.Buy(LotSize, _Symbol);
   else if(sellSignal)
      trade.Sell(LotSize, _Symbol);
}

//+------------------------------------------------------------------+
//| Helper: Close all open positions                                 |
//+------------------------------------------------------------------+
void CloseAllPositions()
{
   for(int i = PositionsTotal() - 1; i >= 0; i--)
   {
      string symbol = PositionGetSymbol(i);
      if(PositionSelect(symbol))
      {
         if(PositionGetInteger(POSITION_TYPE) == POSITION_TYPE_BUY)
            trade.PositionClose(symbol);
         else if(PositionGetInteger(POSITION_TYPE) == POSITION_TYPE_SELL)
            trade.PositionClose(symbol);
      }
   }
}

//+------------------------------------------------------------------+
CTrade trade;

          </textarea
            >
          </div>
        </div>
        <div class="result-panel-content h-flex h-flex--column">
          <h5 for="backtesting-hour">Backtesting Result (Algo)</h5>
          <div class="back-testing-results-grid">
            <div class="first-content h-flex h-flex--column">
              <div class="h-flex h-flex--column">
                <label for="backtesting-strategy" title="CSID: CSID price action breakout with Institutional candle move signal | CSID_W_MA: CSID price action breakout with Institutional candle move signal with moving average | CSID_W_MA_DynamicTS: CSID price action breakout with Institutional candle move signal with moving average and dynamic trailing stop"
                  >Strategy Selection</label
                >
                <select id="backtesting-strategy" class="h-input-effects">
                  <option value="CSID_W_MA_DynamicTS">CSID_W_MA_DynamicTS</option>
                  <option value="CSID_W_MA">CSID_W_MA</option>
                  <option value="CSID">CSID</option>
                </select>
                <label for="backtesting-hour"
                  >Session Start Time (add 2h to match MT5 data)</label
                >
                <input
                  id="backtesting-hour"
                  class="h-input-effects"
                  type="text"
                  value="09:50:00"
                />
              </div>
              <div class="h-flex h-flex--column">
                <label for="backtesting-end"
                  >Session End Time (add 2h to match MT5 data)</label
                >
                <input
                  id="backtesting-end"
                  class="h-input-effects"
                  type="text"
                  value="11:00:00"
                />
              </div>
              <div class="h-flex h-flex--column">
                <label for="MAPeriod" title="Period of Moving Average">Moving Average Period</label>
                <input
                  id="MAPeriod"
                  type="number"
                  value="200"
                  step="10"
                  class="h-input-effects"
                />
              </div>
              <div class="h-flex h-flex--column">
                <label for="MAThreshold" title="How much tilt of moving average for valid acceleration signal">Moving Average Threshold</label>
                <input
                  id="MAThreshold"
                  type="number"
                  value="0.003"
                  class="h-input-effects"
                />
              </div>
              <div class="h-flex h-flex--column">
                <label for="LotSize">Lot Size</label>
                <input
                  id="LotSize"
                  type="number"
                  value="1.0"
                  class="h-input-effects"
                />
                <label for="CommissionSize" title="Use this value for aproximate deduction as fees, swaps or commissions">Commission Aprox. Size</label>
                <input
                  id="CommissionSize"
                  type="number"
                  value="0.00005"
                  class="h-input-effects"
                />
                <label for="" title="Risk:Reward Ratio in points">RR (SL Points | TP Points)</label>
                <input
                  id="SLPoints"
                  type="number"
                  value="0.0001"
                  step="0.0001"
                  class="h-input-effects"
                />
                <input
                  id="TPPoints"
                  type="number"
                  value="0.0003"
                  step="0.0001"
                  class="h-input-effects"
                />
                <label for="TSIncrement" title="Trailing Stop base increment in points">TS Increment</label>
                <input
                  id="TSIncrement"
                  type="number"
                  value="0.0001"
                  step="0.0001"
                  class="h-input-effects"
                  title="Size of trailing stop increment after each candle"
                />
                <div class="h-flex h-flex--center">
                  <button
                    onclick="saveConfigs()"
                    class="mybutton h-input-effects"
                    title="Save Configurations For Next Time"
                  >
                    <i class="far fa-save"></i>
                  </button>
                  <label for="" title="Save the current configuration as URLs parameters for future use. Browser will refresh when saving!">Save Configurations</label>
                </div>
              </div>
            </div>
            <div class="second-content back-testing-results">
              <label for="backtestingResult">Performance Results: </label>
              <textarea
                id="backtestingResult"
                rows="13"
                class="h-field"
              ></textarea>
              <label for="exportableCSVField" title="Easy way to copy paste the backtest result into a google sheet / excel">CSV Exportable text: </label>
              <textarea
                id="exportableCSVField"
                rows="4"
                class="h-field"
              ></textarea>
            </div>
            <div id="myChartContainer" class="third-content" styles="flex-grow: 3; width: 700px">
              <canvas id="myChart" width="700px" height="320px"></canvas>
            </div>
            <div class="fourth-content">
              more stats here
            </div>
          </div>
          <div>
            <h5 for="backtesting-hour">Order History</h5>
            <div id="backtestingResultOrderHistory" class="h-field"></div>
          </div>
        </div>
        <div class="result-panel-content h-flex h-flex--column">
          <h5 for="backtesting-hour">Review Historical Trade</h5>
          <div class="h-flex h-flex--row">
            <div class="h-flex h-flex--column">
              <label for="textareaHistoricalTradesLines"
                >Paste your historical lines (myfxbook for now)</label
              >
              <textarea
                id="textareaHistoricalTradesLines"
                rows="10"
                style="flex-grow: 1; min-width: 600px"
                class="h-field"
              >
2025.05.13 10:17:00	2025.05.13 10:18:00	EURUSD	Sell	1.00	1.11078	-	1.11064	1.11078	-1.4	-16.60	1m	-0.03%	-4.0000</textarea
              >
            </div>
          </div>
          <div>
            <div id="backtestingResultOrderHistory" class="h-field"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Using specific version of scichart for working AxisLabels alignments -->
    <script src="https://cdn.jsdelivr.net/npm/scichart@3.5.782/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="index6.js"></script>
  </body>
</html>
